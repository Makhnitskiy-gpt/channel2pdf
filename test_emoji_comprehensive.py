#!/usr/bin/env python3
"""
–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —ç–º–æ–¥–∑–∏ –≤ PDF.

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç:
1. –≠–º–æ–¥–∑–∏ —Å variation selectors (‚ù§Ô∏è, ‚≠êÔ∏è, ‚úÖ)
2. –°–æ—Å—Ç–∞–≤–Ω—ã–µ —ç–º–æ–¥–∑–∏ (—Ñ–ª–∞–≥–∏, skin tones)
3. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —ç–º–æ–¥–∑–∏ –ø–æ–¥—Ä—è–¥
4. –≠–º–æ–¥–∑–∏ –≤ —Ç–µ–∫—Å—Ç–µ –ø–æ—Å—Ç–æ–≤
5. –≠–º–æ–¥–∑–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞
"""

import os
from datetime import datetime
from pdf_builder import create_pdf
from emoji_handler import normalize_emoji_text, format_reactions_list


def test_emoji_normalization():
    """
    –¢–µ—Å—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —ç–º–æ–¥–∑–∏ (unit test).
    """
    print("=" * 60)
    print("–¢–ï–°–¢ 1: –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —ç–º–æ–¥–∑–∏")
    print("=" * 60)

    test_cases = [
        # (input, expected_output, description)
        ("‚ù§Ô∏è", "‚ù§Ô∏è", "–≠–º–æ–¥–∑–∏ —Å variation selector"),
        ("‚ù§Ô∏è‚ù§Ô∏è", "‚ù§Ô∏è", "–î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è variation selectors"),
        ("—Ç–µ–∫—Å—Ç\u200B\u200C", "—Ç–µ–∫—Å—Ç", "–ù–µ–≤–∏–¥–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã"),
        ("üè≥Ô∏è‚Äçüåà", "üè≥Ô∏è‚Äçüåà", "–°–æ—Å—Ç–∞–≤–Ω–æ–µ —ç–º–æ–¥–∑–∏ (—Ñ–ª–∞–≥ —Ä–∞–¥—É–≥–∏)"),
        ("üë®‚Äçüë©‚Äçüëß‚Äçüë¶", "üë®‚Äçüë©‚Äçüëß‚Äçüë¶", "–°–æ—Å—Ç–∞–≤–Ω–æ–µ —ç–º–æ–¥–∑–∏ (—Å–µ–º—å—è)"),
    ]

    passed = 0
    failed = 0

    for input_text, expected, description in test_cases:
        result = normalize_emoji_text(input_text)
        status = "‚úÖ PASS" if result == expected else "‚ùå FAIL"

        if result == expected:
            passed += 1
        else:
            failed += 1

        print(f"{status} | {description}")
        if result != expected:
            print(f"  –û–∂–∏–¥–∞–ª–æ—Å—å: {repr(expected)}")
            print(f"  –ü–æ–ª—É—á–µ–Ω–æ:  {repr(result)}")

    print(f"\n–†–µ–∑—É–ª—å—Ç–∞—Ç—ã: {passed} —É—Å–ø–µ—à–Ω–æ, {failed} –ø—Ä–æ–≤–∞–ª–µ–Ω–æ\n")


def test_reactions_formatting():
    """
    –¢–µ—Å—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–π (unit test).
    """
    print("=" * 60)
    print("–¢–ï–°–¢ 2: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∞–∫—Ü–∏–π")
    print("=" * 60)

    reactions = [
        {"emoji": "‚ù§Ô∏è", "count": 59},
        {"emoji": "üëç", "count": 33},
        {"emoji": "üî•", "count": 12},
    ]

    result = format_reactions_list(reactions)
    print(f"–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {reactions}")
    print(f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {result}")
    print(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã—Ö –ø—Ä–æ–±–µ–ª–æ–≤: {chr(0x00A0) in result}")
    print()


def test_pdf_generation():
    """
    –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —ç–º–æ–¥–∑–∏ (integration test).
    """
    print("=" * 60)
    print("–¢–ï–°–¢ 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF —Å —ç–º–æ–¥–∑–∏")
    print("=" * 60)

    # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    tmp_dir = "./tmp"
    os.makedirs(tmp_dir, exist_ok=True)

    # –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    test_posts = [
        {
            "date": datetime(2025, 7, 18),
            "text": "ü¶ü –ü–æ—Å—Ç —Å —ç–º–æ–¥–∑–∏ –∫–æ–º–∞—Ä–∞ –≤ –Ω–∞—á–∞–ª–µ —Ç–µ–∫—Å—Ç–∞.\n\n‚ù§Ô∏è –ò —Å–µ—Ä–¥—Ü–µ–º –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ.\n\nüî• –û–≥–æ–Ω—å —Ç–æ–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∏–¥–µ–Ω.",
            "views": 2739,
            "reactions": [
                {"emoji": "ü¶ü", "count": 1},
                {"emoji": "‚ù§Ô∏è", "count": 59},
                {"emoji": "üëç", "count": 33},
                {"emoji": "üî•", "count": 12},
            ]
        },
        {
            "date": datetime(2025, 7, 19),
            "text": "–ü–æ—Å—Ç —Å —ç–º–æ–¥–∑–∏ –≤–æ –≤—Å–µ—Ö —Ä–µ–∞–∫—Ü–∏—è—Ö: üòÇüéâüíØüëèüöÄ",
            "views": 1500,
            "reactions": [
                {"emoji": "üòÇ", "count": 45},
                {"emoji": "‚ù§Ô∏è", "count": 30},
                {"emoji": "üéâ", "count": 20},
                {"emoji": "üíØ", "count": 15},
                {"emoji": "üëè", "count": 10},
                {"emoji": "üöÄ", "count": 5},
            ]
        },
        {
            "date": datetime(2025, 7, 20),
            "text": "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö —ç–º–æ–¥–∑–∏:\nüè≥Ô∏è‚Äçüåà –§–ª–∞–≥ —Ä–∞–¥—É–≥–∏\nüë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–µ–º—å—è\nüëçüèª –ü–∞–ª–µ—Ü –≤–≤–µ—Ä—Ö (—Å–≤–µ—Ç–ª–∞—è –∫–æ–∂–∞)",
            "views": 890,
            "reactions": [
                {"emoji": "‚ù§Ô∏è", "count": 100},
                {"emoji": "‚≠ê", "count": 50},
                {"emoji": "‚úÖ", "count": 25},
                {"emoji": "üôè", "count": 15},
            ]
        },
        {
            "date": datetime(2025, 7, 21),
            "text": "–¢–µ—Å—Ç —ç–º–æ–¥–∑–∏ —Å variation selectors:\n‚ù§Ô∏è –°–µ—Ä–¥—Ü–µ\n‚≠êÔ∏è –ó–≤–µ–∑–¥–∞\n‚úÖ –ì–∞–ª–æ—á–∫–∞",
            "views": 543,
            "reactions": [
                {"emoji": "‚ù§Ô∏è", "count": 200},
                {"emoji": "‚≠êÔ∏è", "count": 150},
                {"emoji": "‚úÖ", "count": 100},
            ]
        }
    ]

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF —Å —ç–º–æ–¥–∑–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞
    output_file = os.path.join(tmp_dir, "emoji_comprehensive_test.pdf")
    channel_name = "üì± –¢–µ—Å—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª —Å —ç–º–æ–¥–∑–∏ ‚ù§Ô∏è"

    print(f"–ì–µ–Ω–µ—Ä–∏—Ä—É—é PDF: {output_file}")
    pdf_path = create_pdf(test_posts, output_file, channel_name)

    print(f"‚úÖ PDF —Å–æ–∑–¥–∞–Ω: {pdf_path}\n")

    return pdf_path


def main():
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è - –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ —Ç–µ—Å—Ç—ã.
    """
    print("\n" + "=" * 60)
    print("–ö–û–ú–ü–õ–ï–ö–°–ù–´–ô –¢–ï–°–¢ –û–ë–†–ê–ë–û–¢–ö–ò –≠–ú–û–î–ó–ò –í PDF")
    print("=" * 60 + "\n")

    # Unit tests
    test_emoji_normalization()
    test_reactions_formatting()

    # Integration test
    pdf_path = test_pdf_generation()

    # –§–∏–Ω–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
    print("=" * 60)
    print("–ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í")
    print("=" * 60)
    print(f"\nüìÑ –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª: {pdf_path}")
    print("\n‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ:")
    print("   1. –í—Å–µ —ç–º–æ–¥–∑–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–Ω–µ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤)")
    print("   2. –ù–µ—Ç '—Å–µ—Ä—ã—Ö —É—à–µ–∫' –∏–ª–∏ –Ω–∞–ª–æ–∂–µ–Ω–∏–π –Ω–∞–¥/–ø–µ—Ä–µ–¥ ‚ù§Ô∏è")
    print("   3. –ö–∞–∂–¥–æ–µ —ç–º–æ–¥–∑–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑")
    print("   4. –°–æ—Å—Ç–∞–≤–Ω—ã–µ —ç–º–æ–¥–∑–∏ (üè≥Ô∏è‚Äçüåà, üë®‚Äçüë©‚Äçüëß‚Äçüë¶) –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ")
    print("   5. –≠–º–æ–¥–∑–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
    print("   6. –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–±–µ–ª—ã –º–µ–∂–¥—É —ç–º–æ–¥–∑–∏ –∏ —Ü–∏—Ñ—Ä–∞–º–∏ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ")
    print("\n" + "=" * 60 + "\n")


if __name__ == "__main__":
    main()
