#!/usr/bin/env python3
"""
CLI-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–≥–æ–≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ Channel2PDF.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    python analyze_logs.py

–°–∫—Ä–∏–ø—Ç —á–∏—Ç–∞–µ—Ç —Ñ–∞–π–ª server.log –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –≤—ã–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç
—Å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –ø–æ —Å–æ–±—ã—Ç–∏—è–º, —è–∑—ã–∫–∞–º, –æ—à–∏–±–∫–∞–º –∏ –¥–Ω—è–º.
"""

from log_parser import parse_log_file, format_analytics_report
import sys
from pathlib import Path


def main():
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è CLI-—Å–∫—Ä–∏–ø—Ç–∞.
    """
    # –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –ª–æ–≥–æ–≤
    log_path = "server.log"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
    if not Path(log_path).exists():
        print(f"‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª {log_path} –Ω–µ –Ω–∞–π–¥–µ–Ω", file=sys.stderr)
        print(f"–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞", file=sys.stderr)
        sys.exit(1)

    # –ü–∞—Ä—Å–∏–º –ª–æ–≥–∏
    print("–ß–∏—Ç–∞—é –ª–æ–≥–∏...", file=sys.stderr)
    analytics = parse_log_file(log_path)

    # –ï—Å–ª–∏ –Ω–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
    if analytics.valid_events == 0:
        print(f"\n‚ö†Ô∏è  –í —Ñ–∞–π–ª–µ {log_path} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤–∞–ª–∏–¥–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏", file=sys.stderr)
        print(f"–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤ JSON-—Ñ–æ—Ä–º–∞—Ç–µ", file=sys.stderr)
        sys.exit(0)

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏ –≤—ã–≤–æ–¥–∏–º –æ—Ç—á—ë—Ç
    report = format_analytics_report(analytics, max_channels=10)
    print(report)

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞
    print("\nüí° –°–æ–≤–µ—Ç—ã –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:")
    print("=" * 70)
    print()
    print("1. –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º:")
    print("   –î–æ–±–∞–≤—å—Ç–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã --date-from –∏ --date-to –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏")
    print("   —Å–æ–±—ã—Ç–∏–π –ø–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–º—É –¥–∏–∞–ø–∞–∑–æ–Ω—É.")
    print()
    print("2. –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è:")
    print("   –î–æ–±–∞–≤—å—Ç–µ –∞—Ä–≥—É–º–µ–Ω—Ç --event-type –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–æ–ª—å–∫–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö")
    print("   —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–ª—å–∫–æ export_failed).")
    print()
    print("3. –≠–∫—Å–ø–æ—Ä—Ç –≤ –¥—Ä—É–≥–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã:")
    print("   –î–æ–±–∞–≤—å—Ç–µ –∞—Ä–≥—É–º–µ–Ω—Ç --format json|csv –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö")
    print("   –≤ –º–∞—à–∏–Ω–æ—á–∏—Ç–∞–µ–º—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö.")
    print()
    print("4. –ê–Ω–∞–ª–∏–∑ User-Agent:")
    print("   –î–æ–±–∞–≤—å—Ç–µ –ø–∞—Ä—Å–∏–Ω–≥ user_agent –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–æ–≤ —É—Å—Ç—Ä–æ–π—Å—Ç–≤")
    print("   –∏ –±—Ä–∞—É–∑–µ—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")
    print()
    print("5. –í—Ä–µ–º–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞:")
    print("   –î–æ–±–∞–≤—å—Ç–µ —Ä–∞–∑–±–∏–≤–∫—É –ø–æ —á–∞—Å–∞–º —Å—É—Ç–æ–∫ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è")
    print("   –ø–∏–∫–æ–≤—ã—Ö –≤—Ä–µ–º—ë–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.")
    print()
    print("6. –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞:")
    print("   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ GeoIP –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω")
    print("   –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —Ö—ç—à–∞–º IP (—Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏).")
    print()


if __name__ == "__main__":
    main()
