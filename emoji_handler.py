"""
–ú–æ–¥—É–ª—å –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —ç–º–æ–¥–∑–∏ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF.

–ü—Ä–æ–±–ª–µ–º–∞: WeasyPrint –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–∞–≤–Ω—ã–µ —ç–º–æ–¥–∑–∏ —Å variation selectors (–Ω–∞–ø—Ä–∏–º–µ—Ä, ‚ù§Ô∏è = U+2764 + U+FE0F).
–≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞–º - –Ω–∞–ª–æ–∂–µ–Ω–∏—é –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≥–ª–∏—Ñ–æ–≤ –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞.

–†–µ—à–µ–Ω–∏–µ:
1. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è variation selectors
2. –Ø–≤–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ emoji-—à—Ä–∏—Ñ—Ç–æ–≤ —á–µ—Ä–µ–∑ @font-face –≤ WeasyPrint
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –º–µ–∂–¥—É —ç–º–æ–¥–∑–∏ –∏ —Ü–∏—Ñ—Ä–∞–º–∏
"""

import re
import unicodedata


def normalize_emoji_text(text):
    """
    –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ç–µ–∫—Å—Ç —Å —ç–º–æ–¥–∑–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ PDF.

    –í—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:
    1. –£–¥–∞–ª—è–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è variation selectors (U+FE0F, U+FE0E)
    2. –ü—Ä–∏–º–µ–Ω—è–µ—Ç Unicode –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é NFC (Canonical Decomposition, followed by Canonical Composition)
    3. –û—á–∏—â–∞–µ—Ç –Ω–µ–≤–∏–¥–∏–º—ã–µ —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –º–µ—à–∞—Ç—å —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É

    Args:
        text (str): –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç —Å —ç–º–æ–¥–∑–∏

    Returns:
        str: –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç

    Examples:
        >>> normalize_emoji_text("‚ù§Ô∏è‚ù§Ô∏è")  # –î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è variation selectors
        "‚ù§Ô∏è"
        >>> normalize_emoji_text("—Ç–µ–∫—Å—Ç\u200B\u200C")  # –ù–µ–≤–∏–¥–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã
        "—Ç–µ–∫—Å—Ç"
    """
    if not text:
        return text

    # 1. –ü—Ä–∏–º–µ–Ω—è–µ–º Unicode –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é NFC
    # NFC –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Å–æ—Å—Ç–∞–≤–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –∏—Ö –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫—É—é —Ñ–æ—Ä–º—É
    text = unicodedata.normalize('NFC', text)

    # 2. –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è variation selectors
    # Variation Selector-16 (U+FE0F) - —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ emoji-–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
    # Variation Selector-15 (U+FE0E) - —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
    # –ü—Ä–æ–±–ª–µ–º–∞: –∏–Ω–æ–≥–¥–∞ –æ–Ω–∏ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è –∏–ª–∏ —Å–º–µ—à–∏–≤–∞—é—Ç—Å—è, –≤—ã–∑—ã–≤–∞—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã

    # –ü–∞—Ç—Ç–µ—Ä–Ω: –Ω–∞—Ö–æ–¥–∏–º variation selector, –∑–∞ –∫–æ—Ç–æ—Ä—ã–º —Å—Ä–∞–∑—É —Å–ª–µ–¥—É–µ—Ç –µ—â—ë –æ–¥–∏–Ω
    text = re.sub(r'[\uFE0E\uFE0F]{2,}', '\uFE0F', text)  # –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã ‚Üí –æ–¥–∏–Ω emoji-—Å–µ–ª–µ–∫—Ç–æ—Ä

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: —É–¥–∞–ª—è–µ–º –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —ç–º–æ–¥–∑–∏+selector –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
    # –ù–∞–ø—Ä–∏–º–µ—Ä: ‚ù§Ô∏è‚ù§Ô∏è (–≥–¥–µ –∫–∞–∂–¥–æ–µ —Å–µ—Ä–¥—Ü–µ = U+2764 + U+FE0F)
    # –ü–∞—Ç—Ç–µ—Ä–Ω: —Å–∏–º–≤–æ–ª + variation selector, –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–π—Å—è –ø–æ–¥—Ä—è–¥
    text = re.sub(r'([\u2600-\u27BF\U0001F300-\U0001F9FF][\uFE0F\uFE0E]?)\1+', r'\1', text)

    # 3. –£–¥–∞–ª—è–µ–º –Ω–µ–≤–∏–¥–∏–º—ã–µ —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
    # Zero Width Joiner (U+200D) –æ—Å—Ç–∞–≤–ª—è–µ–º - –æ–Ω –Ω—É–∂–µ–Ω –¥–ª—è —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö —ç–º–æ–¥–∑–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–ª–∞–≥–∏, skin tones)
    invisible_chars = [
        '\u200B',  # Zero Width Space
        '\u200C',  # Zero Width Non-Joiner
        '\uFEFF',  # Zero Width No-Break Space (BOM)
    ]
    for char in invisible_chars:
        text = text.replace(char, '')

    # 4. –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—Ä–æ–±–µ–ª—ã –≤–æ–∫—Ä—É–≥ —ç–º–æ–¥–∑–∏
    # –ó–∞–º–µ–Ω—è–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –Ω–∞ –æ–¥–∏–Ω–æ—á–Ω—ã–µ
    text = re.sub(r'\s{2,}', ' ', text)

    return text


def format_emoji_with_count(emoji, count):
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —ç–º–æ–¥–∑–∏ —Å —á–∏—Å–ª–æ–º –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ PDF.

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–π –ø—Ä–æ–±–µ–ª (U+00A0) –º–µ–∂–¥—É —ç–º–æ–¥–∑–∏ –∏ —á–∏—Å–ª–æ–º,
    —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —Ä–∞–∑—Ä—ã–≤ —Å—Ç—Ä–æ–∫–∏ –º–µ–∂–¥—É –Ω–∏–º–∏ –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç—å
    –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ.

    Args:
        emoji (str): –≠–º–æ–¥–∑–∏ —Å–∏–º–≤–æ–ª
        count (int): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∞–∫—Ü–∏–π

    Returns:
        str: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ "emoji NBSP count"

    Examples:
        >>> format_emoji_with_count("‚ù§Ô∏è", 59)
        "‚ù§Ô∏è 59"  # –° –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–º –ø—Ä–æ–±–µ–ª–æ–º
    """
    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —ç–º–æ–¥–∑–∏
    emoji = normalize_emoji_text(emoji)

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–π –ø—Ä–æ–±–µ–ª (U+00A0) –º–µ–∂–¥—É —ç–º–æ–¥–∑–∏ –∏ —á–∏—Å–ª–æ–º
    # –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ä–∞–∑—Ä—ã–≤ —Å—Ç—Ä–æ–∫–∏ –∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ–º
    nbsp = '\u00A0'

    return f"{emoji}{nbsp}{count}"


def format_reactions_list(reactions):
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ —Ä–µ–∞–∫—Ü–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ PDF.

    Args:
        reactions (list): –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∫–ª—é—á–∞–º–∏ 'emoji' –∏ 'count'

    Returns:
        str: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –≤–∏–¥–∞ "emoji‚ÇÅ count‚ÇÅ, emoji‚ÇÇ count‚ÇÇ, ..."

    Examples:
        >>> reactions = [{"emoji": "‚ù§Ô∏è", "count": 59}, {"emoji": "üëç", "count": 33}]
        >>> format_reactions_list(reactions)
        "‚ù§Ô∏è 59, üëç 33"  # –° –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–º–∏ –ø—Ä–æ–±–µ–ª–∞–º–∏
    """
    if not reactions:
        return ""

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é —Ä–µ–∞–∫—Ü–∏—é –∏ –æ–±—ä–µ–¥–∏–Ω—è–µ–º —á–µ—Ä–µ–∑ ", "
    formatted = [format_emoji_with_count(r['emoji'], r['count']) for r in reactions]

    return ", ".join(formatted)


def get_emoji_font_css():
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç CSS –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è emoji-—à—Ä–∏—Ñ—Ç–æ–≤ –∫ WeasyPrint.

    –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç @font-face –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —è–≤–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    emoji-—à—Ä–∏—Ñ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä Unicode —ç–º–æ–¥–∑–∏.

    Returns:
        str: CSS-–∫–æ–¥ —Å @font-face –ø—Ä–∞–≤–∏–ª–∞–º–∏

    Note:
        –ü–æ—Ä—è–¥–æ–∫ —à—Ä–∏—Ñ—Ç–æ–≤ –≤ font-family –≤–∞–∂–µ–Ω:
        1. Symbola - –æ—Å–Ω–æ–≤–Ω–æ–π emoji-—à—Ä–∏—Ñ—Ç (—à–∏—Ä–æ–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Unicode)
        2. –°–∏—Å—Ç–µ–º–Ω—ã–µ emoji-—à—Ä–∏—Ñ—Ç—ã (Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji)
        3. –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —à—Ä–∏—Ñ—Ç—ã
        4. Sans-serif fallback
    """
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç–∏ –∫ —à—Ä–∏—Ñ—Ç–∞–º
    fonts_dir = "fonts"

    css = f"""
    /* –Ø–≤–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ emoji-—à—Ä–∏—Ñ—Ç–æ–≤ –¥–ª—è WeasyPrint */
    @font-face {{
        font-family: 'Symbola';
        src: url('{fonts_dir}/Symbola.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
    }}

    @font-face {{
        font-family: 'DejaVu Sans';
        src: url('{fonts_dir}/DejaVuSans.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
    }}

    @font-face {{
        font-family: 'Noto Sans';
        src: url('{fonts_dir}/NotoSans-Regular.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
    }}
    """

    return css


def get_emoji_safe_font_family():
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç font-family —Å—Ç—Ä–æ–∫—É, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —ç–º–æ–¥–∑–∏.

    Returns:
        str: –ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è CSS —Å–≤–æ–π—Å—Ç–≤–∞ font-family

    Note:
        –ü–æ—Ä—è–¥–æ–∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:
        1. 'Symbola' - –º–æ–Ω–æ—Ö—Ä–æ–º–Ω—ã–π —à—Ä–∏—Ñ—Ç —Å –ø–æ–ª–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Unicode —ç–º–æ–¥–∑–∏
        2. 'DejaVu Sans' - –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —à—Ä–∏—Ñ—Ç
        3. 'Noto Sans' - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —à—Ä–∏—Ñ—Ç
        4. –°–∏—Å—Ç–µ–º–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã –∫–∞–∫ fallback
    """
    return "'Symbola', 'DejaVu Sans', 'Noto Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif"
